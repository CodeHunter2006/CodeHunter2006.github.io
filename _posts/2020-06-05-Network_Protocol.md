---
layout: post
title: "Network Protocols"
date: 2020-06-05 22:00:00 +0800
tags: Server
---

![Fitness](/assets/images/2020-06-05-Network_Protocol_1.jpeg)

# 网络分层模型

## 网络传输可能发生的问题：

- 数据丢包
- 数据重复
- 数据完整性校验
- 数字信号转模拟信号
- 不同介质间的转换
- 信号衰减

## 通过网络分层解决网络可靠性问题

将网络分层，遵守严格的分层模式，上下两层之间保持接口不变，这样可以修改、替换其中一层，不会影响其他层。

常用的网络分层：

- OSI(Open System Interconnection Reference Model)开放系统互联参考模型
- TCP/IP 协议族，OSI 的表示、会话两层被合并入应用层

# HTTP(HyperText Transfer Protocol)

超文本传输协议

## 一个 HTTP 请求流程

1. 在浏览器输入网址按下回车
   浏览器解析出网址的域名部分、在浏览器缓存查询域名
2. 通过域名查找 DNS 得到 IP 地址
   浏览器缓存、Host 文件、操作系统缓存、DNS 服务器
3. 通过 IP 地址访问服务器，发送 HTTP 请求
   TCP 三次握手(/TLS 握手)、将数据放入缓冲区、服务端程序处理
4. 收到结果
   服务器返回 http 响应、浏览器解析响应、渲染页面、TCP 四次挥手

## Status Code(状态码)

每次请求返回一个状态码，由三位数字表示

- 1xx 过程中
  - 100 continue
- 2xx 成功
  - 200 OK
- 3xx 重定向
- 4xx 客户端错误
  - 400 用户请求通用错误；403 用户无该路径权限；404 路径不存在；
- 5xx 服务器错误
  - 500 服务器内部通用错误；

# HTTPS(Hyper Text Transfer Protocol over SecureSocket Layer)

在 HTTP 的基础上通过传输加密和身份认证保证了传输过程的安全性。

# SSL/TSL(Secure Sockets Layer/Transport Layer Security)

SSL 由 Netscape 公司 1994 年发明并于 1999 年改名为 TSL，是信息安全领域的权威标准。

- 数字证书的组成
  CA 信息、公钥用户信息、公钥、权威机构的签名、有效期
- 数字证书的作用
  1. 通过数字证书向浏览器证明身份
  2. 数字证书里包含了公钥

# DNS(Domain Name System)

域名系统，将 IP 和域名地址相互映射的一个分布式数据库。

DNS 查询过程(一旦找到就返回)：
浏览器域名缓存->本地 Host 文件->操作系统本地缓存->向设置/(网络接入商提供的)默认 的 DNS 服务器查询 IP->向上级查询直到根域名服务器

- DNS 基于 UDP 协议工作

# TCP(Transmission Control Protocol)

传输控制协议，是一种面向连接的、可靠的、基于字节流的传输层通信协议。

## 特点

- 基于连接的
  数据传输之前需要建立连接
- 全双工
  数据同时双向传输
- 字节流
  不限制数据大小，打包成报文段，保证有序接收，重复报文自动丢弃
  由于发送数据时可能经过不同的路由，所以底层很容发生乱序或重复
- 流量缓冲
  解决双方处理能力的不匹配
- 可靠的传输服务
  保证可达，丢包时通过重发机制实现可靠性
- 拥塞控制
  在网速较差或网络稳定性较差时，会发生大量丢包，这时算法会主动将包切的更小，并降低发送频率，防止网络出现恶性拥塞

## 报文结构

![TCP](/assets/images/2020-06-05-Network_Protocol_2.png)

1. 源端口、目的端口
   在 TCP 通信时发起的一方要先知道监听方的端口号
2. 序号
   Seq 序号，占 32 位，用来标识从 TCP 源端向目的端发送的字节流，发起方发送数据时对此进行标记，每次根据发送数据量进行增长。
   - 假设一个报文段的序号字段是 301，且携带了 100 字节的数据，则第一个字节的序号是 301，最后一个字节的序号是 400。如果有下一个报文段，则数据序号应从 401 开始。
3. 确认序号(Acknowledge Sequence)
   Ack 序号，占 32 位，只有 ACK 标志位为 1 时，确认序号字段才有效，Ack=Seq+1。
4. 标志位：共 6 个，即 URG、ACK、PSH、RST、SYN、FIN 等，具体含义如下：

- URG：紧急指针（urgent pointer）有效。
- ACK：确认序号有效。
- PSH：接收方应该尽快将这个报文交给应用层。
- RST：重置连接。
- SYN：发起一个新连接。
- FIN：释放一个连接。

5. 接收窗口
   是指发送这个报文的发送者，缓冲区剩余容量的大小。
6. 紧急指针
   如果 URG 标识位为 1，则优先处理紧急指针这里的数据

- 数据包通常由很多层组成，越靠前越是底层协议，例如 HTTP 基于 TCP 基于 IP，那么数据包结构是 IP 头 + IP 数据(TCP 头 + TCP 数据(HTTP 头 + HTTP 数据))，从数据上看是先看到各个协议的头
- 数据包的头的顺序与协议栈相一致

## TCP 连接管理

TCP 连接四元组：源地址、源端口、目的地址、目的端口

- 可以用`tcpdump`工具抓包分析

### 三次握手

- 三次握手的目的：
  1. 同步通信双方初始序列号(ISN, Initial Sequence Number)
  2. 协商 TCP 通信参数(MSS MaximumSegmentSize 最大报文长度、窗口信息、校验和算法)

![TCP](/assets/images/2020-06-05-Network_Protocol_3.png)

- 首先服务端要监听特定的端口号，发起握手的客户端要提前知道并使用这个端口号
- 客户端发起连接时，一般会随机选择自己的一个端口号
- 握手时，双方初次发出的 Seq 是各自独立生成的随机数
- 握手时，每次通信 ACK 值都是 Seq+1，表示之前的 Seq 被消耗掉了，这种情况在数据传输时不会发生。数据传输时，只会根据容量正常消耗 Seq。

### 四次挥手

四次挥手的关键是双向通道独立关闭过程。

![TCP](/assets/images/2020-06-05-Network_Protocol_4.png)

- **MSL**最大报文生存时间
  - 如果最后客户端没有等待 2MSL 就关闭，会造成两种问题：
    1. 万一最后的 ACK 没有到达服务端，那服务端会不断发 FIN，持续占用资源无法释放
    2. 前一个连接没有等待就关闭，立刻在相同端口号建立新连接，那么新旧数据就可能同时被接收，造成混乱
- 双方都可以主动发起关闭连接，我们这里把主动关闭的一方称为客户端

### 数据可靠性保证

![TCP](/assets/images/2020-06-05-Network_Protocol_7.jpg)
如果每次发送都要求一个 ACK，然后再发下一个包，这样效率极低。

实际上使用的是滑动窗口协议与累计确认(延时 ACK)算法。

![TCP](/assets/images/2020-06-05-Network_Protocol_5.jpg)

- 如图所示，发送数据队列分为下列区域：
  - 已发送并收到确认
  - 已发送但未收到确认
  - 未发送并处于发送窗口中
  - 未发送但未处于发送窗口中

![TCP](/assets/images/2020-06-05-Network_Protocol_6.jpeg)

- 发送后的数据如果超时仍未收到 ACK，则会重发，并且限制窗口移动速度

## 常见问题

- TCP 保证数据完整性吗？发送者如何知道发送成功？
  保证完整性。发送方调用函数，最终将数据发到对方的缓冲区后就返回成功。

- 为什么 TCP 保证了传输数据的正确性，还需要在应用层加 CRC 或 MD5 校验？
  因为处于不同的层。TCP 在传输层保证正确性，但是应用层收到数据后可能未正常保存就崩溃了，这种情况下在 TCP 层看到是正常传输完毕的，而最终文件却有问题，需要校验。

# UDP(User Datagram Protocol)

用户数据报协议，提供了一种无需建立连接就可以发送封装的 IP 数据包的方法。

# SCTP()

# IP(Internet Protocol)

网际互连协议，IP 只为主机提供一种无连接、不可靠的、尽力而为的数据报传输服务。
IP 主要包含三方面内容：IP 编址方案、分组封装格式及分组转发规则。

# ARP(Address Resolution Protocol)

地址解析协议，工作于网络层，是根据 IP 地址获取物理地址的一个 TCP/IP 协议。
在每个主机上保存一个 IP 到 MAC 地址的映射表。想要查询映射关系的主机将包含目标 IP 地址的 ARP 请求广播到局域网的所有主机，具有该 IP 地址的主机收到请求会返回自己的 MAC 地址，然后主动查询的主机收到后可以将映射关系缓存在自己本地。

## 常见问题

- ARP 是基于局域网之间主机互信的前提的，所以可能被恶意主机返回虚假 ARP 应答报文，使发送者的信息被发送到错误的主机
- 我们如果手动设置了多台主机的 IP 地址为同一个值，会引起 IP 地址冲突
