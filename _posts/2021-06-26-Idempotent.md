---
layout: post
title: "幂等问题的应对方案"
date: 2021-06-26 23:00:00 +0800
tags: Server
---

# 什么是幂等

对于**写入**的请求，多次执行不会造成**数据不一致**问题，那么这个处理过程具有**幂等性**。

- 幂等接口要求对同一事务重复执行不会造成重复等数据不一致问题
- 幂等接口的返回值可以随操作次数不同而不同，不会影响最终存储

- 非幂等造成**数据不一致**问题的场景：
  - 网络请求下，由于超时未响应，又重复请求了一次，而实际上被执行了两次
  - 页面上的按钮，不小心点击了多次
  - MQ 中间件，重复消费消息
  - 第三方回调接口(如支付成功)，由于网络问题重复回调
  - 其他只要是**异步**的操作，都有可能发生幂等问题

# 幂等场景

- 下面 SQL CRUD 是否幂等？

  - **查询** `select * from user where xxx`
    查询不会造成数据不一致，具备幂等性
  - **新增** `insert into user(userid,name) values(1,'a')`
    - 如 userid 为**唯一主键**，即重复操作上面的业务，只会插入一条用户数据，具备幂等性
    - 如 userid**不是主键**，可以重复，那上面业务多次操作，数据都会新增多条，不具备幂等性
  - **修改**
    - **直接赋值** `update user set point = 20 where userid=1`
      直接赋最终值，point 始终一样，具备幂等性
    - **计算赋值** `update user set point = point + 20 where userid=1`
      每次操作 point 数据都不一样，不具备幂等性
  - **删除** `delete from user where userid=1`
    多次操作，结果一样，具备幂等性

- 上面场景中**新增没有唯一约束数据**和**计算赋值**都不具备幂等性，需要有应对方案

# Token 机制

- 概要流程：

  1. 客户端请求显示表单
  2. 服务端生成一个 token，记录在 redis，返回给客户端的表单中带这个 token
  3. 客户端填写表单，发送提交到服务端
  4. 服务端检查 redis 中的 token 是否被使用过，如果没用过，则正常处理
  5. 如果服务端检查 token 被使用过，则返回错误，表示不能重复处理，实现幂等

- 上面流程中，服务端何时标记 redis 中的 token "已使用"状态，是一个设计难点
  - 问题：
    - 如果先做标记，再处理，这时如果服务端挂了，那么再没有机会处理
    - 如果先处理再标记，如果处理完未标记就挂了，则之后可能重复处理
  - 方案：
  - 这是一个典型的**数据库和缓存 redis 数据不一致** 问题，
    可以按**先标记再处理**来处理，这样如果未能处理，客户端只要再请求新 token 重试一次即可，
    不会造成重复处理的严重问题。

# 乐观锁机制

# 唯一主键机制

# 总结
