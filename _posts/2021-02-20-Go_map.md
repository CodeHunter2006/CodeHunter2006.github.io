---
layout: post
title: "Go map sync.Map"
date: 2021-02-20 22:00:00 +0800
tags: Go
---

# map

hmap

- B 桶的个数的指数

- flag 并发操作标志

bmap

overflow 溢出桶

- 等量扩容

- 倍增扩容

扩容过程新值写入新桶中

倍增扩容时，遍历旧桶元素，重新分配到新桶的低或高位，使用`B+1`位区分

# sync.Map

1. 空间换时间。通过冗余的两个数据结构(read、dirty),实现加锁对性能的影响。
2. 使用只读数据(read)，避免读写冲突。
3. 动态调整，miss 次数多了之后，将 dirty 数据提升为 read。
4. double-checking。
5. 延迟删除。删除一个键值只是打标记，只有在提升 dirty 的时候才清理删除的数据。
6. 优先从 read 读取、更新、删除，因为对 read 的读取不需要锁。
