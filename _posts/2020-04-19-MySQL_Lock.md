---
layout: post
title: "MySQL Lock"
date: 2020-04-19 23:00:00 +0800
tags: MySQL
---

锁机制是为了解决并发问题。

# 用锁保证事务

## 事务的四大特性 （ACID）

1. 原子性（Atomicity） 事务是一个不可分割的工作单位，事务中的操作要么都发生，要么都不发生。
2. 一致性（Consistency）事务前后数据的完整性必须保持一致。
3. 隔离性（Isolation）多个用户并发访问数据库时，一个用户的事务不能被其它用户的事务所干扰，多个并发事务之间的数据要相互隔离。
4. 持久性（Durability）一个事务一旦被提交，它对数据库中的数据改变就是永久性的。

## 可能引发的问题

**脏读** 事务 A 读到了事务 B 未提交的数据。
**不可重复读** 事务 A 第一次查询得到一行记录 row1，事务 B 提交修改后，事务 A 第二次查询得到 row1，但列内容发生了变化。
**幻读** 事务 A 第一次查询得到一行记录 row1，事务 B 提交修改后，事务 A 第二次查询得到两行记录 row1 和 row2。
**丢失更新** 事务 A B 两次更新顺序到来，最后结果应该是 B，但是在并发更新结束后，结果是 A，B 被覆盖了。

## 四种隔离级别及其特点

| 隔离级别                      | 存在脏读 | 存在不可重复读 | 存在幻读 |
| ----------------------------- | -------- | -------------- | -------- |
| Read UnCommit(未提交读)       | Y        | Y              | Y        |
| Read Commit(提交读)           | N        | Y              | Y        |
| Repeated Reader(可重复读)     | N        | N              | Y        |
| Serializable Reader(序列化读) | N        | N              | N        |

# 锁的分类

- 根据操作类型分为：
  - 读锁(共享锁)，对同一个数据，多个读操作可以同时进行，互不干扰。
  - 写锁(互斥锁)，如果当前操作没有完毕，则无法进行其他的读/写操作。
- 根据操作范围分为：
  - 表锁，对一张表加锁。如 MyISAM 存储引擎使用表锁，开销小、加锁快、无死锁，锁范围大，容易发生冲突，并发度低。
  - 行锁，对一条数据加锁。如 InnoDB 存储引擎默认使用行锁，开销大、加锁慢、容易发生死锁，锁范围较小，不易发生锁冲突，并发度高。
  - 页锁

# 加锁 SQL

## 表锁

- `lock table t1 read/write` 加一个表级的读/写锁
- `unlock tables` 释放锁，也可以用事务解锁
- `show open tables` 查看表的加锁数量
- `show status like '%Table%'` 查看表锁情况，其中`Table_locks_immediate`是立即可加锁的表数量，`Table_locks_waited`是需要等待的表锁数。
  - 通常用`Table_locks_immediate/Table_locks_waited`作为参考数据，如果 > 5000 建议采用 InnoDB，否则用 MyISAM 引擎。

## 行锁

- 通常增删改是通过事务来加锁的
- 可以在查询语句后面加`for update`开启一个行写锁，如:`select * from t1 where id = 1 for update;`
- `show status like '%innodb_row_lock%'` 查看行锁情况(从系统启动到现在)
  - `innodb_row_lock_current_waits` 当前正在等待的锁的数量
  - `innodb_row_lock_time` 等待总时长
  - `innodb_row_lock_time_avg` 平均等待时长
  - `innodb_row_lock_time_max` 最大等待时长
  - `innodb_row_lock_waits` 等待次数

# 锁的效果

## 表锁

- 如果某 session 对 A 表加读锁，则可以对 A 表进行读操作、不可以写操作，当前会话不可以对其他表进行读/写操作。
  - 这时另一个 session 对 A 表可以读，写时会等待，对其他表可以读/写操作。
- 如果某 session 对 A 表加写锁，则可以对 A 表进行任何操作，但是不可以对其他表进行操作。
  - 这时另一个 session 对 A 表任何操作将等待。

## 行锁(InnoDB)

如果某会话 A 正在对某条数据进行增删改操作，其他会话会等待，必须等 A 结束事务后再继续。

### 行锁注意事项

- 如果没有索引，行锁会转为表锁。例如，在索引失效时，行锁会退化为表锁。

### 间隙锁

一种特殊的行锁，值在范围内但不存在。例如，已有数据 id 1~5，这时 where id 范围是 2~7，则 6~7 是间隙锁

# 锁的流程

MyISAM 在执行查询语句(select)之前，会自动给涉及的所有表加读锁；在执行增删改之前，会自动给涉及的表加写锁。
