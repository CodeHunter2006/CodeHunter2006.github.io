---
layout: post
title: "Redis集群方案"
date: 2021-04-09 10:00:00 +0800
tags: Redis Distribute
---

基本的 Redis 分布式结构可参考[Redis 分布式](/2019/01/28/Redis_distribute/)
这里继续探讨 Redis 集群方案中涉及的一致性问题

# 基本概念

"Redis 集群"的说法并不准确，只要是多台主配合实现功能就可以称为"集群"

- Redis 实际上有两种分布式结构：
  - **主从复制集群**
  - **cluster 模式集群**

## 主从复制集群

- 主从复制集群实现了 HA(高可用)，解决了单点故障
- 主从间数据保持同步，数据是全量的
- 主从复制取 AP，强调速度快，但是同步不精准，一致性不足

- 哨兵只是提供 HA 切换的功能(人工也是一样的)，不影响整体架构

## cluster 模式集群

- cluster 模式实现了"分治、分片"，解决了容量、压力的瓶颈问题
- 每个结点存储一部分数据
- Cluster 模式取 CP

- 往往主从复制模式和 Cluster 模式是综合应用的。可以给 Cluster 模式的每一个主加上从已保证 HA(High Availability)
- cluster 前面可以加一个 Codis 代理，以便执行 pipeline 等辅助操作

## 客户端/代理分区

一个客户端同时与多个 Redis 实例连接，在客户端可以先 Hash 一次，然后再到对应的 Redis 进行操作。
为了避免客户端和 Redis 连接过多以及实例扩展困难的情况，在中间增加代理解决

# 主从复制模式

- 一个 Master 可以配备一个或多个 Slave

- 为了保证 Slave 与 Master 之间数据一致，有以下机制：

  - 连接正常时，Master 会发送一系列命令流来更新 Slave，包括：客户端写入、key 的过期或被(容量不足)逐出
    - 每个 Slave 会被分配一个 ID，在 Master 会根据 Slave 的 ID 和 Offset 同步命令
  - 当 Master 和 Slave 之间的连接断开后，Slave 在重新连接后会努力尝试网络断开期间丢失的命令流
  - 如果无法同步(Offset 与最新命令 ID 差异超过了指定阀值)，Slave 会请求全量同步，全量同步会同步快照，然后再同步快照过程中的新命令流

- Redis 主从同步方式默认为异步，也可以配置为同步，但是会降低整体性能，反过来降低了崩溃丢消息的概率

- Redis 2.8.18 是第一个支持无磁盘复制的版本，在 Slave 需要全量同步时，Master 直接把内存中的 RDB 发送给 Slave，而不需要保存到硬盘，提高了性能。

## 哨兵模式

主从模式发生故障后，如果主自动启动了，可以自动恢复。否则需要手动选择一个从切换为主。
但是这个过程需要自动化，所以就有了哨兵模式，Redis2.8 提供了哨兵 2.0。

哨兵会通过心跳检查，判断 Master 是否客观下线，然后就由领头哨兵执行 Failover 操作，将其中一个从变为主，在 Failover 过程中系统阻塞对外服务。

- 哨兵判断客观下线过程：

  1. 其中一个哨兵发现 Ping Master 后没有响应，则当前哨兵认为 Master 主观下线
  2. 哨兵发送`SENTINEL is-master-down-by-addr`命令给其他哨兵判断是否 Master 主观下线
  3. 收到超过 quorum 的哨兵数量主观下线，则认为 Master 已客观下线，开始执行 Failover

- 选取领头哨兵过程：Raft 算法

  1. 发现 Master 客观下线的哨兵(A)向其他哨兵发送命令，要求选举自己成为领头哨兵
  2. 如果收到选举命令的哨兵没有选举过别的结点，则会同意选 A
  3. 如果 A 发现超过 quorum 的哨兵选择了自己，则认为自己是领头哨兵
  4. 当有多个哨兵同时参选，则会出现没有任何节点当选的可能，此时每个参选节点将等待一个随即时间重新发起竞选，直到选举成功

- Failover(故障恢复)过程

  1. 从所有在线的从库中，选取设置的优先级最高的，优先级可以通过`slave-priority`来设置
  2. 如果优先级相同，则按照复制命令的偏移量 Offset 越大越优先
  3. 如果偏移量相同，则按照 RunID(每个从库唯一)，越小越优先
  4. 选择好节点后，领头哨兵将向这个节点发送`slaveof no one`，升级他为主库
  5. 然后向其他从数据库发送`slaveof`命令切换主库
  6. 最后更新内部的记录，将已经停止服务的旧的主数据库更新为新的主数据库的从数据库，当其回复后自动以从数据库的身份加入到主从架构中

- 哨兵本身也同时部署多个，可以相互监控。推荐的哨兵部署方案：

  1. 为每个节点(无论是主数据库还是从数据库)都部署一个哨兵
  2. 使每个哨兵与其对应的节点的网络环境相同或相近

- 一般设置 quorum 的值为 N/2+1

## 配置方式

1. 从配置文件`slaveof 192.168.1.1 6379`，就实现了基本的主从
2. 从设置`slave-read-only`可以开启从的只读模式
3. 如果主设置了密码，从需设置`masterauth <password>`
